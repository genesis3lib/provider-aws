name: Code-320-Server-Ec2-Pwd

on:
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  id-token: write

env:
  TF_VERSION: "1.12.2"
  AWS_REGION: {{region}}

jobs:
  server-operations:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-environment

      - name: Configure AWS credentials
        uses: ./.github/actions/aws-credentials
        with:
          account-id: {{{githubVarsOpen}}} vars.AWS_ACCOUNT_ID {{{githubVarsClose}}}
          role-name: {{projectName}}-{{{githubVarsOpen}}} env.ENVIRONMENT  {{{githubVarsClose}}}-ops-deploy-ec2-role

      - name: Display Environment Info
        run: |
          echo "Event name: {{{githubVarsOpen}}} github.event_name  {{{githubVarsClose}}}"
          echo "Branch: {{{githubVarsOpen}}} env.BRANCH  {{{githubVarsClose}}}"
          echo "Environment: {{{githubVarsOpen}}} env.ENVIRONMENT  {{{githubVarsClose}}}"

      - name: Get Terraform Outputs
        uses: ./.github/actions/terraform-outputs
        with:
          terraform-dir: {{opsModule.moduleId}}/terraform
          environment: {{{githubVarsOpen}}} env.ENVIRONMENT  {{{githubVarsClose}}}
          project-name: {{projectName}}

      - name: Discover EC2 Instances
        id: ec2-discovery
        uses: ./.github/actions/ec2-discovery
        with:
          project-name: {{projectName}}
          environment: {{{githubVarsOpen}}} env.ENVIRONMENT  {{{githubVarsClose}}}
          fail-if-empty: 'false'

      - name: Check if instances found
        run: |
          if [ -z "${EC2_INSTANCES}" ]; then
            echo "‚ö†Ô∏è Skipping password setup - no instances to configure"
            echo "SKIP_PASSWORD_SETUP=true" >> $GITHUB_ENV
          fi


      - name: Setup EC2 User Password for ttyS0 Access
        if: env.SKIP_PASSWORD_SETUP != 'true'
        run: |
          echo "üîê Setting up ec2-user password for ttyS0 SSH access..."
          
          # Generate a secure password
          PASSWORD=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-20)
          echo "Generated password for ec2-user: ${PASSWORD}"
          
          # Convert comma-separated instances to space-separated for AWS CLI
          INSTANCE_LIST=$(echo "${EC2_INSTANCES}" | tr ',' ' ')
          echo "Target instances: ${INSTANCE_LIST}"
          
          # Set password for ec2-user on all instances
          echo "üîß Setting ec2-user password on all instances..."
          PASSWORD_COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${INSTANCE_LIST} \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "echo Setting up SSH password authentication for ec2-user",
              "echo ec2-user:'${PASSWORD}' | sudo chpasswd",
              "sudo usermod -U ec2-user",
              "sudo sed -i s/PasswordAuthentication.*/PasswordAuthentication\\ yes/g /etc/ssh/sshd_config",
              "sudo sed -i s/#PasswordAuthentication.*/PasswordAuthentication\\ yes/g /etc/ssh/sshd_config",
              "sudo systemctl reload sshd",
              "echo Password authentication enabled for SSH",
              "echo Username: ec2-user",
              "echo Password: '${PASSWORD}'"
            ]' \
            --timeout-seconds 300 \
            --query 'Command.CommandId' \
            --output text)
          
          echo "Password Setup Command ID: ${PASSWORD_COMMAND_ID}"
          
          # Wait for command completion
          echo "‚è≥ Waiting for password setup to complete..."
          
          # Convert instances to array for status checking
          IFS=' ' read -ra INSTANCE_ARRAY <<< "${INSTANCE_LIST}"
          
          # Wait for command completion on all instances
          for i in {1..20}; do
            ALL_COMPLETE=true
            ALL_SUCCESS=true
            
            echo "=== Checking password setup status (attempt ${i}/20) ==="
            
            for INSTANCE in "${INSTANCE_ARRAY[@]}"; do
              # Trim whitespace
              INSTANCE=$(echo "${INSTANCE}" | xargs)
              
              STATUS=$(aws ssm get-command-invocation \
                --command-id "${PASSWORD_COMMAND_ID}" \
                --instance-id "${INSTANCE}" \
                --query 'Status' \
                --output text 2>/dev/null || echo "InProgress")
              
              echo "üìä Instance ${INSTANCE}: ${STATUS}"
              
              if [ "${STATUS}" = "Failed" ]; then
                echo "‚ùå Password setup failed on instance ${INSTANCE}"
                aws ssm get-command-invocation \
                  --command-id "${PASSWORD_COMMAND_ID}" \
                  --instance-id "${INSTANCE}" \
                  --query 'StandardErrorContent' \
                  --output text
              elif [ "${STATUS}" != "Success" ]; then
                ALL_SUCCESS=false
                if [ "${STATUS}" = "InProgress" ]; then
                  ALL_COMPLETE=false
                fi
              fi
            done
            
            if [ "${ALL_SUCCESS}" = "true" ]; then
              echo "‚úÖ Password setup completed successfully on all instances"
              echo "üîë SSH Access Information:"
              echo "  Username: ec2-user"
              echo "  Password: ${PASSWORD}"
              echo "  SSH Command: ssh ec2-user@<instance-ip>"
              echo "  Console Access: Available via ttyS0"
              break
            fi
            
            if [ "${ALL_COMPLETE}" = "true" ]; then
              echo "‚ùå Some instances completed but not all succeeded"
              # Continue anyway, password setup is not critical
              break
            fi
            
            sleep 5
          done
          
          echo "üîê EC2 user password setup completed"
